<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Visualizador de KML por OS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    :root {
      --accent: #c62828;
      --accent-2: #168f4b;
      --accent-light: #fdecec;
      --bg: #f9fbff;
      --card-bg: #ffffff;
      --text: #0f172a;
      --muted: #64748b;
      --border: #e2e8f0;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background:
        radial-gradient(circle at 10% 20%, rgba(198,40,40,0.08), transparent 32%),
        radial-gradient(circle at 85% 10%, rgba(22,143,75,0.08), transparent 38%),
        linear-gradient(180deg, #fdf7f4 0%, #f2f7ff 70%, #fdf7f4 100%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      align-items: stretch;
      justify-content: center;
    }

    .container {
      width: 100%;
      max-width: 1200px;
      margin: 16px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .card {
      background: var(--card-bg);
      border-radius: 16px;
      border: 1px solid var(--border);
      box-shadow: 0 18px 40px rgba(15,23,42,0.12);
      padding: 16px 18px;
    }

    .header .title { display: flex; align-items: center; gap: 10px; }
    .header .title::before{
      content: '';
      width:10px;
      height:10px;
      background: linear-gradient(45deg,#d9b24c,#a37e20);
      border-radius:3px;
      display:inline-block;
    }

    .form-row { align-items: center; gap: 10px; }
    .form-row label { width: 120px; min-width: 90px; }
    .form-row input[type="text"] { max-width: 260px; }

    .btn-action { background: linear-gradient(135deg,#d9b24c,#987417); color: #fff; }
    .btn-secondary { background: #fff; color: var(--muted); border: 1px solid var(--border); box-shadow:none; }
    .form-row button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 9px 14px;
      position: relative;
      min-height: 40px;
    }
    .btn-label { display: inline-flex; align-items: center; font-weight: 600; letter-spacing: 0.01em; }
    .btn-icon {
      width: 18px;
      height: 18px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      color: #000000;
    }
    .btn-icon svg { width: 100%; height: 100%; stroke: currentColor; }

    .card[style] { padding: 12px; }
    #map { border-radius: 12px; border: 1px solid rgba(255,255,255,0.03); }

    .header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 8px;
      align-items: center;
      margin-bottom: 8px;
    }
    .header-actions { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }

    .title {
      font-size: 1.2rem;
      font-weight: 600;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: #040404;
    }

    .subtitle {
      font-size: 0.8rem;
      color: var(--muted);
    }

    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-top: 8px;
    }

    label {
      font-size: 1rem;
      color: #212529;
    }

    input[type="text"] {
      flex: 1;
      min-width: 140px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      font-size: 0.9rem;
      background: rgba(255, 255, 255, 0.95);
      color: var(--text);
      outline: none;
    }

    input[type="text"]:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(22, 163, 74, 0.6);
    }

    button {
      padding: 6px 14px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: linear-gradient(135deg, #c62828, #ef5350);
      color: #fff;
      box-shadow: 0 12px 25px rgba(198, 40, 40, 0.3);
      transition: transform 0.08s ease, box-shadow 0.08s ease, filter 0.1s ease;
    }

    button:hover {
      transform: translateY(-1px);
      filter: brightness(1.05);
      box-shadow: 0 16px 35px rgba(22, 163, 74, 0.5);
    }

    button:active {
      transform: translateY(0);
      box-shadow: 0 8px 18px linear-gradient(135deg, #d9b24c, #a48942);
    }

    button:disabled {
      opacity: 0.55;
      cursor: not-allowed;
      box-shadow: none;
      filter: none;
    }

    .btn-secondary {
      background: #fff;
      color: #090a0c;
      border: 1px solid var(--border);
      box-shadow: none;
    }

    .btn-secondary:hover {
      background: rgba(0, 0, 0, 0.06);
      box-shadow: 0 8px 20px rgba(198, 40, 40, 0.16);
    }

    #message {
      margin-top: 6px;
      font-size: 0.8rem;
      min-height: 1.2em;
    }

    #message.success {
      color: var(--accent);
    }

    #message.error {
      color: #c62828;
    }

    #map {
      width: 100%;
      height: calc(100vh - 200px);
      min-height: 360px;
      border-radius: 14px;
      overflow: hidden;
      border: 1px solid var(--border);
      background:#fff;
    }

    .map-footer {
      font-size: 0.75rem;
      color: var(--muted);
      margin-top: 6px;
      display: flex;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
    }

    /* Abas Mapa / PDF */
    .tabs {
      display: inline-flex;
      gap: 6px;
      background: #f7fafc;
      border-radius: 999px;
      padding: 4px;
      margin-bottom: 8px;
      border:1px solid var(--border);
    }

    .tab-button {
      border-radius: 999px;
      border: none;
      padding: 6px 12px;
      font-size: 0.8rem;
      cursor: pointer;
      background: transparent;
      color: var(--muted);
      box-shadow: none;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      transition: background 0.12s ease, color 0.12s ease, box-shadow 0.12s ease;
    }

    .tab-button.tab-active {
      background: linear-gradient(135deg, #8d722a, #8d722a);
      color: #fff;
      box-shadow:0 10px 20px rgba(198,40,40,0.22);
    }

    .tab-content {
      display: none;
    }

    .tab-content.tab-active {
      display: block;
    }

    #pdfFrame {
      width: 100%;
      height: calc(100vh - 230px);
      min-height: 360px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: #fff;
    }

    #pdfPlaceholder {
      font-size: 0.8rem;
      color: var(--muted);
      margin-bottom: 4px;
    }

    @media (max-width: 768px) {
      .container {
        margin: 10px;
      }

      #map {
        height: calc(100vh - 220px);
      }

      #pdfFrame {
        height: calc(100vh - 230px);
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="header">
        <div>
          <div class="title">Visualizador de OS ¬∑ KML + PDF</div>
          <div class="subtitle">Digite o n√∫mero da OS para carregar o desenho da √°rea e a pr√©via em PDF diretamente do Google Drive.</div>
        </div>
        <div class="header-actions">

            
          </button>
        </div>
      </div>

      <div class="form-row">
        <label for="osInput">N√∫mero da OS:</label>
        <input type="text" id="osInput" placeholder="Ex: 710987" />
        <button id="btnBuscar" type="button" class="btn-action">
          <span class="btn-icon" aria-hidden="true"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg></span>
          <span class="btn-label">Buscar OS</span>
        </button>
        <button id="btnLimpar" type="button" class="btn-secondary">
          <span class="btn-icon" aria-hidden="true"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"></path><path d="M10 11v6"></path><path d="M14 11v6"></path><path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"></path></svg></span>
          <span class="btn-label">Limpar</span>
        </button>
        <button id="btnDownload" type="button" class="btn-secondary" disabled>
          <span class="btn-icon" aria-hidden="true"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 17l4 4 4-4"></path><path d="M12 12v9"></path><path d="M20.88 18.09A4 4 0 0 0 18 10h-1.26A8 8 0 1 0 3 16"></path></svg></span>
          <span class="btn-label">Baixar KML</span>
        </button>
        <button id="btnNavigate" type="button" class="btn-secondary" disabled>
          <span class="btn-icon" aria-hidden="true"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="3 11 22 2 13 21 11 13 3 11"></polygon></svg></span>
          <span class="btn-label">Navegar at√© √°rea</span>
        </button>
        <button id="btnLocate" type="button" class="btn-secondary">
          <span class="btn-icon" aria-hidden="true"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13S3 17 3 10a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg></span>
          <span class="btn-label">Minha posi√ß√£o</span>
        </button>
      </div>

      <div id="message"></div>
    </div>

    <div class="card" style="padding: 10px 12px;">
      <!-- Abas -->
      <div class="tabs">
        <button type="button" class="tab-button tab-active" data-tab="mapa">
          üó∫Ô∏è <span>Mapa</span>
        </button>
        <button type="button" class="tab-button" data-tab="pdf">
          üìÑ <span>PDF</span>
        </button>
      </div>

      <!-- Conte√∫do da aba Mapa -->
      <div class="tab-content tab-active" id="tab-mapa">
        <div id="map"></div>
        <div class="map-footer">
          <span>üõ∞Ô∏è Zoom autom√°tico na √°rea encontrada ¬∑ pol√≠gonos em destaque e popup com nome + √°rea (ha).</span>
          <span id="statusInfo"></span>
        </div>
      </div>

      <!-- Conte√∫do da aba PDF -->
      <div class="tab-content" id="tab-pdf">
        <div id="pdfPlaceholder">Busque uma OS para carregar a pr√©-visualiza√ß√£o do PDF.</div>
        <iframe id="pdfFrame" title="Pr√©-visualiza√ß√£o da OS"></iframe>
      </div>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- toGeoJSON -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/togeojson/0.16.0/togeojson.min.js"></script>

  <!-- Turf.js -->
  <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>

  <!-- Lucide icons -->
  <script src="https://cdn.jsdelivr.net/npm/lucide@0.278.0/dist/lucide.min.js"></script>

  <script>
    // URL do seu Web App (exec) ‚Äì a mesma que voc√™ me mandou:
    const API_URL = "https://script.google.com/macros/s/AKfycbx_tOQPnkKfIa1spUqL-UrPUcc3vylLI_dp9v55OFaxuRR3UA6MKht4sEQsEWpYl8ko/exec";

    let map;
    let kmlLayer = null;
    let lastKmlText = null;
    let lastKmlFileName = null;
    let lastKmlOS = null;
    let lastGeoJson = null;
    let lastUserMarker = null;
    let lastUserAccuracy = null;

    // URL atual do blob do PDF (pra revogar quando limpar/trocar)
    let currentPdfUrl = null;

    function initMap() {
      map = L.map('map', {
        zoomControl: true,
        attributionControl: true
      }).setView([-15.8, -48.5], 4); // Brasil

      const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap'
      });

      const esriSat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        maxZoom: 19,
        attribution: 'Tiles &copy; Esri'
      });

      const baseLayers = {
        'Mapa (OSM)': osm,
        'Sat√©lite (Esri)': esriSat
      };

      osm.addTo(map);
      L.control.layers(baseLayers, null, { collapsed: false }).addTo(map);

      const compassControl = L.control({ position: 'topleft' });
      compassControl.onAdd = function() {
        const div = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
        div.innerHTML = '<div style="width:40px;height:40px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:24px;background:#fff;border-radius:4px;">‚Üë</div>';
        div.style.marginTop = '50px';
        L.DomEvent.on(div, 'click', function(){
          map.setView(map.getCenter(), map.getZoom());
        });
        return div;
      };
      compassControl.addTo(map);
    }

    function setMessage(text, type) {
      const messageEl = document.getElementById('message');
      messageEl.textContent = text || '';
      messageEl.className = '';
      if (type) messageEl.classList.add(type);
    }

    function setStatus(text) {
      document.getElementById('statusInfo').textContent = text || '';
    }

    function limparMapa() {
      if (kmlLayer) {
        map.removeLayer(kmlLayer);
        kmlLayer = null;
      }
      setStatus('');
      clearPdfPreview('Nenhum PDF carregado.');
      lastKmlText = null;
      lastKmlFileName = null;
      lastKmlOS = null;
      lastGeoJson = null;
      enableDownload(false);
      enableNav(false);
    }

    // ---- Abas (Mapa / PDF) ----
    function switchTab(tabName) {
      const buttons = document.querySelectorAll('.tab-button');
      const contents = document.querySelectorAll('.tab-content');

      buttons.forEach(btn => {
        const tab = btn.getAttribute('data-tab');
        if (tab === tabName) btn.classList.add('tab-active');
        else btn.classList.remove('tab-active');
      });

      contents.forEach(content => {
        if (content.id === 'tab-' + tabName) content.classList.add('tab-active');
        else content.classList.remove('tab-active');
      });
    }

    // ---- PDF Preview via JSONP + Base64 ----
    function updatePdfPreview(osNumero) {
      const frame = document.getElementById('pdfFrame');
      const placeholder = document.getElementById('pdfPlaceholder');
      if (!frame || !placeholder) return;

      placeholder.textContent = 'Carregando PDF da OS ' + osNumero + '...';

      // Revoga blob antigo
      if (currentPdfUrl) {
        URL.revokeObjectURL(currentPdfUrl);
        currentPdfUrl = null;
      }
      frame.src = 'about:blank';

      // Remove JSONP anterior
      const oldScript = document.getElementById('jsonp_pdf_script');
      if (oldScript) oldScript.remove();

      // Callback que o Apps Script vai chamar
      window.handlePdfResponse = function(data) {
        if (!data || !data.success || !data.pdfBase64) {
          placeholder.textContent = (data && data.message)
            ? data.message
            : 'Nenhum PDF encontrado para esta OS.';
          frame.src = 'about:blank';
          return;
        }

        try {
          const byteChars = atob(data.pdfBase64);
          const len = byteChars.length;
          const bytes = new Uint8Array(len);
          for (let i = 0; i < len; i++) {
            bytes[i] = byteChars.charCodeAt(i);
          }
          const blob = new Blob([bytes], { type: 'application/pdf' });
          const url = URL.createObjectURL(blob);
          currentPdfUrl = url;

          frame.src = url;
          placeholder.textContent = 'PDF carregado: ' + (data.fileName || '');
        } catch (e) {
          console.error('Erro ao montar PDF:', e);
          placeholder.textContent = 'Erro ao exibir o PDF.';
          frame.src = 'about:blank';
        }
      };

      const script = document.createElement('script');
      script.id = 'jsonp_pdf_script';
      script.src = `${API_URL}?os=${encodeURIComponent(osNumero)}&formato=pdfjson&callback=handlePdfResponse&_=${Date.now()}`;
      document.body.appendChild(script);
    }

    function clearPdfPreview(msg) {
      const frame = document.getElementById('pdfFrame');
      const placeholder = document.getElementById('pdfPlaceholder');

      if (currentPdfUrl) {
        URL.revokeObjectURL(currentPdfUrl);
        currentPdfUrl = null;
      }

      if (frame) frame.src = 'about:blank';
      if (placeholder) placeholder.textContent = msg || 'Nenhum PDF carregado.';

      const oldScript = document.getElementById('jsonp_pdf_script');
      if (oldScript) oldScript.remove();
    }

    // Busca KML via JSONP
    function buscarKml() {
      const osNumero = document.getElementById('osInput').value.trim();

      if (!osNumero) {
        setMessage('Digite o n√∫mero da OS.', 'error');
        return;
      }

      setMessage('Buscando KML no Google Drive...', 'success');
      setStatus('');
      clearPdfPreview('Preparando pr√©-visualiza√ß√£o do PDF...');

      lastKmlText = null;
      lastKmlFileName = null;
      lastKmlOS = null;
      enableDownload(false);

      const oldScript = document.getElementById('jsonp_kml_script');
      if (oldScript) oldScript.remove();

      window.handleKmlResponse = function (data) {
        if (!data || !data.success) {
          limparMapa();
          setMessage(data && data.message ? data.message : 'KML n√£o encontrado.', 'error');
          clearPdfPreview('Nenhum PDF encontrado para esta OS.');
          return;
        }

        lastKmlText = data.kmlContent || null;
        lastKmlFileName = data.fileName ? String(data.fileName) : `OS_${osNumero}.kml`;
        lastKmlOS = osNumero;
        enableDownload(!!lastKmlText);

        setMessage('KML carregado: ' + (data.fileName || ''), 'success');
        renderKmlOnMap(data.kmlContent, data.fileName, osNumero);

        // Atualiza a aba PDF
        updatePdfPreview(osNumero);
      };

      const script = document.createElement('script');
      script.id = 'jsonp_kml_script';
      script.src = `${API_URL}?os=${encodeURIComponent(osNumero)}&callback=handleKmlResponse&_=${Date.now()}`;
      document.body.appendChild(script);
    }

    function renderKmlOnMap(kmlText, fileName, osNumero) {
      try {
        if (kmlLayer) {
          map.removeLayer(kmlLayer);
          kmlLayer = null;
        }

        const parser = new DOMParser();
        const kmlDom = parser.parseFromString(kmlText, 'text/xml');
        const geojson = toGeoJSON.kml(kmlDom);

        try { lastGeoJson = geojson; } catch (_e) { lastGeoJson = null; }

        if (!geojson || !geojson.features || geojson.features.length === 0) {
          setMessage('KML carregado, mas sem fei√ß√µes v√°lidas para exibi√ß√£o.', 'error');
          return;
        }

        let totalAreaHa = 0;

        kmlLayer = L.geoJSON(geojson, {
          style: function () {
            return {
              color: '#22c55e',
              weight: 2,
              fillColor: '#16a34a',
              fillOpacity: 0.35
            };
          },
          onEachFeature: function (feature, layer) {
            const props = feature.properties || {};

            let nome = props.name || props.NOME || props.Nome || '';
            if (!nome) {
              nome = props.nome_faz || fileName || ('OS ' + osNumero);
            }

            const codFazenda = props.fazenda || props['tal:fazenda'] || '';
            const nomeFazenda = props.nome_faz || props['tal:nome_faz'] || '';
            const talhao = props.talhao || props['tal:talhao'] || '';
            const areaAttr = props.area || props['tal:area'] || '';

            let areaHa = 0;
            try {
              const areaM2 = turf.area(feature);
              areaHa = areaM2 / 10000.0;
              totalAreaHa += areaHa;
            } catch (e) {}

            const popupHtml = `
              <strong>${nome}</strong><br>
              OS: <strong>${osNumero}</strong><br>
              Fazenda: ${nomeFazenda || '-'} ${codFazenda ? '(' + codFazenda + ')' : ''}<br>
              Talh√£o: ${talhao || '-'}<br>
              √Årea (KML): ${areaAttr ? Number(areaAttr).toFixed(2) + ' ha' : '-'}<br>
              √Årea (geometria): ${areaHa > 0 ? areaHa.toFixed(2) + ' ha' : 'n√£o calculada'}
            `;
            layer.bindPopup(popupHtml);
          }
        }).addTo(map);

        try {
          map.fitBounds(kmlLayer.getBounds(), { padding: [20, 20] });
        } catch (e) {
          console.log('N√£o foi poss√≠vel ajustar o zoom automaticamente:', e);
        }

        if (totalAreaHa > 0) {
          setStatus('√Årea total estimada: ' + totalAreaHa.toFixed(2) + ' ha');
        } else {
          setStatus('');
        }

        enableNav(!!lastGeoJson);
      } catch (e) {
        console.error(e);
        setMessage('Erro ao processar o KML no mapa: ' + e, 'error');
      }
    }

    function enableNav(enabled) {
      const btn = document.getElementById('btnNavigate');
      if (!btn) return;
      btn.disabled = !enabled;
      if (enabled) btn.classList.remove('btn-secondary');
      else btn.classList.add('btn-secondary');
      try { if (window.lucide) lucide.createIcons(); } catch (_e) {}
    }

    function navigateToKml() {
      if (!lastGeoJson) {
        setMessage('Nenhuma √°rea carregada para navegar.', 'error');
        return;
      }

      let centroid;
      try {
        centroid = turf.centroid(lastGeoJson);
      } catch (e) {
        console.error('Erro ao calcular centroid:', e);
        setMessage('N√£o foi poss√≠vel calcular ponto de destino.', 'error');
        return;
      }

      if (!centroid || !centroid.geometry || !centroid.geometry.coordinates) {
        setMessage('Ponto de destino inv√°lido.', 'error');
        return;
      }

      const [lon, lat] = centroid.geometry.coordinates;
      const destLat = Number(lat);
      const destLon = Number(lon);

      setMessage('Obtendo sua posi√ß√£o para navega√ß√£o...', 'success');

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function (pos) {
          const oLat = pos.coords.latitude;
          const oLon = pos.coords.longitude;
          const origin = `${oLat},${oLon}`;
          const destination = `${destLat},${destLon}`;
          const url = `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(origin)}&destination=${encodeURIComponent(destination)}&travelmode=driving`;
          window.open(url, '_blank');
        }, function (err) {
          console.warn('Geolocation failed or denied:', err);
          setMessage('N√£o foi poss√≠vel obter sua localiza√ß√£o ‚Äî abrindo destino no Google Maps.', 'error');
          const destination = `${destLat},${destLon}`;
          const url = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(destination)}`;
          window.open(url, '_blank');
        }, { enableHighAccuracy: true, timeout: 8000 });
      } else {
        setMessage('Geolocaliza√ß√£o n√£o suportada ‚Äî abrindo destino no Google Maps.', 'error');
        const destination = `${destLat},${destLon}`;
        const url = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(destination)}`;
        window.open(url, '_blank');
      }
    }

    function enableDownload(enabled) {
      const btn = document.getElementById('btnDownload');
      if (!btn) return;
      btn.disabled = !enabled;
      if (enabled) btn.classList.remove('btn-secondary');
      else btn.classList.add('btn-secondary');
      try { if (window.lucide) lucide.createIcons(); } catch (_e) {}
    }

    function downloadKml() {
      if (!lastKmlText) {
        setMessage('Nenhum KML dispon√≠vel para download.', 'error');
        return;
      }
      try {
        const blob = new Blob([lastKmlText], { type: 'application/vnd.google-earth.kml+xml;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = lastKmlFileName || (`kml_${lastKmlOS || ''}.kml`);
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
        setMessage('Download iniciado: ' + a.download, 'success');
      } catch (e) {
        console.error(e);
        setMessage('Falha ao iniciar download: ' + e, 'error');
      }
    }

    function showUserLocation() {
      if (!navigator.geolocation) {
        setMessage('Navegador n√£o suporta geolocaliza√ß√£o.', 'error');
        return;
      }
      setMessage('Obtendo sua localiza√ß√£o...', 'success');
      navigator.geolocation.getCurrentPosition(function (pos) {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        const accuracy = pos.coords.accuracy || 0;

        if (lastUserMarker) {
          try { map.removeLayer(lastUserMarker); } catch (_e) {}
          lastUserMarker = null;
        }
        if (lastUserAccuracy) {
          try { map.removeLayer(lastUserAccuracy); } catch (_e) {}
          lastUserAccuracy = null;
        }

        lastUserMarker = L.marker([lat, lon]).addTo(map).bindPopup('Sua posi√ß√£o').openPopup();
        lastUserAccuracy = L.circle([lat, lon], { radius: accuracy, color: '#3b82f6', fillColor: '#bfdbfe', fillOpacity: 0.25 }).addTo(map);

        try { map.panTo([lat, lon]); } catch (_e) {}
        setMessage('Posi√ß√£o localizada (precis√£o ‚âà ' + Math.round(accuracy) + ' m).', 'success');
      }, function (err) {
        console.warn('Geolocation error', err);
        setMessage('N√£o foi poss√≠vel obter sua localiza√ß√£o: ' + (err && err.message ? err.message : err), 'error');
      }, { enableHighAccuracy: true, timeout: 10000 });
    }

    document.addEventListener('DOMContentLoaded', function () {
      initMap();

      document.getElementById('btnBuscar').addEventListener('click', buscarKml);
      document.getElementById('btnLimpar').addEventListener('click', () => {
        limparMapa();
        setMessage('Mapa limpo. Digite uma nova OS para buscar.', 'success');
      });

      const btnDl = document.getElementById('btnDownload');
      if (btnDl) btnDl.addEventListener('click', downloadKml);
      const btnNav = document.getElementById('btnNavigate');
      if (btnNav) btnNav.addEventListener('click', navigateToKml);
      const btnLocate = document.getElementById('btnLocate');
      if (btnLocate) btnLocate.addEventListener('click', showUserLocation);

      document.querySelectorAll('.tab-button').forEach(btn => {
        btn.addEventListener('click', () => {
          const tab = btn.getAttribute('data-tab');
          switchTab(tab);
        });
      });

      // Lucide
      let lucideInitAttempts = 0;
      const maxLucideRetries = 5;
      const lucideRetryDelay = 250;

      function initLucide(){
        if (window.lucide && typeof lucide.createIcons === 'function') {
          try {
            lucide.createIcons();
          } catch(e) {
            console.error('Lucide init error:', e);
          }
          return;
        }

        lucideInitAttempts += 1;
        if (lucideInitAttempts <= maxLucideRetries) {
          setTimeout(initLucide, lucideRetryDelay);
        }
      }

      const lucideScriptTag = document.querySelector('script[src*="lucide"]');
      if (lucideScriptTag) {
        lucideScriptTag.addEventListener('load', initLucide);
      }
      initLucide();

      document.getElementById('osInput').addEventListener('keydown', function (e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          buscarKml();
        }
      });
    });
  </script>
</body>
</html>
