<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Upload de KML - Top Gun</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    :root{
      --bg:#f3f6fb;
      --card:#ffffff;
      --border:#d9e1ec;
      --primary:#2563eb;
      --text:#0f172a;
      --muted:#475569;
    }
    *{
      box-sizing:border-box;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
    }
    body{
      margin:0;
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      color:var(--text);
      background: linear-gradient(160deg, #f8fbff 0%, #eef3fb 50%, #e3ebf8 100%);
    }
    .card{
      background:var(--card);
      border-radius:18px;
      border:1px solid #000000;
      padding:24px 26px;
      max-width:480px;
      width:100%;
      box-shadow:0 16px 48px rgba(15, 23, 42, 0.12);
    }
    .title{
      font-size:1.4rem;
      font-weight:700;
      letter-spacing:.08em;
      text-transform:uppercase;
      color:var(--primary);
      margin-bottom:4px;
    }
    .subtitle{
      font-size:.9rem;
      color:var(--muted);
      margin-bottom:18px;
    }
    .highlight{
      color:var(--text);
      font-weight:600;
    }
    .drop-zone{
      border-radius:14px;
      border:1px dashed #cbd5e1;
      background:#f8fafc;
      padding:28px 18px;
      text-align:center;
      transition:all .2s;
      cursor:pointer;
      position:relative;
    }
    .drop-zone.dragover{
      border-color:var(--primary);
      box-shadow:0 0 18px rgba(37,99,235,0.25);
      transform:translateY(-1px);
    }
    .drop-title{
      font-size:1rem;
      font-weight:600;
      margin-bottom:4px;
    }
    .drop-sub{
      font-size:.85rem;
      color:var(--muted);
    }
    .file-input{
      display:none;
    }
    .files-list{
      margin-top:10px;
      font-size:.8rem;
      color:var(--muted);
      max-height:120px;
      overflow:auto;
      text-align:left;
    }
    .files-list div{
      border-bottom:1px solid #e2e8f0;
      padding:4px 0;
      display:flex;
      justify-content:space-between;
      gap:8px;
    }
    .files-list span.name{
      color:var(--text);
    }
    .files-list span.size{
      color:#64748b;
      white-space:nowrap;
    }
    .actions{
      display:flex;
      gap:10px;
      margin-top:18px;
    }
    button{
      border-radius:999px;
      border:1px solid transparent;
      padding:10px 16px;
      font-size:.9rem;
      font-weight:600;
      cursor:pointer;
      min-width:0;
      flex:1;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      transition:all .18s;
    }
    .btn-secondary{
      background:#e2e8f0;
      border-color:#cbd5e1;
      color:var(--text);
    }
    .btn-secondary:hover{
      border-color:#94a3b8;
      background:#cbd5e1;
    }
    .btn-primary{
      background:var(--primary);
      color:#ffffff;
      box-shadow:0 10px 28px rgba(37,99,235,0.35);
    }
    .btn-primary:hover{
      filter:brightness(1.06);
      box-shadow:0 12px 32px rgba(37,99,235,0.4);
    }
    .status{
      margin-top:10px;
      font-size:.8rem;
      color:var(--muted);
    }
    .status.ok{
      color:#16a34a;
    }
    .status.err{
      color:#dc2626;
    }
    .top-actions{
      display:flex;
      justify-content:flex-start;
      margin-bottom:12px;
    }
    .back-btn{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:9px 14px;
      border-radius:999px;
      border:1px solid #cbd5e1;
      background:#ffdd2a;
      color:var(--text);
      text-decoration:none;
      font-weight:600;
      transition:all .18s;
    }
    .back-btn:hover{
      background:#dde5f1;
      border-color:#94a3b8;
      transform:translateY(-1px);
    }
    @media (max-width:600px){
      .card{
        margin:16px;
        padding:20px 18px;
      }
      .actions{
        flex-direction:column;
      }
    }
  </style>
</head>
<body>
  <div class="card">
    <div class="top-actions">
      <a class="back-btn" href="index.html">← Voltar</a>
    </div>
    <div class="title">UPLOAD DE KML</div>
    <div class="subtitle">
      Envie aqui os arquivos <span class="highlight">.kml ou .pdf</span> que devem ir para a mesma pasta do
      <span class="highlight">encontrar_kml</span> no Google Drive.
    </div>

    <form id="uploadForm">
      <div id="dropZone" class="drop-zone">
        <div class="drop-title">Clique aqui ou arraste os KML ou PDF</div>
        <div class="drop-sub">Formatos aceitos: <b>.kml / .pdf</b> (pode selecionar vários)</div>
        <input id="fileInput" class="file-input" type="file" name="arquivos" multiple accept=".kml,.pdf">
      </div>

      <div id="filesList" class="files-list"></div>

      <div class="actions">
        <button type="button" class="btn-secondary" id="btnClear">Limpar</button>
        <button type="submit" class="btn-primary" id="btnUpload">Enviar para o Drive</button>
      </div>

      <div id="status" class="status"></div>
    </form>
  </div>

  <script>
    // URL do seu Web App (exec)
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxvd7CLbTLAM2E_QLBq9sZha4M5H9QhGiL_SGrTPPJerv5yOZptn_OMvix6ZaNuxQNnmw/exec';

    const dropZone  = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const filesList = document.getElementById('filesList');
    const form      = document.getElementById('uploadForm');
    const statusEl  = document.getElementById('status');
    const btnClear  = document.getElementById('btnClear');
    const btnUpload = document.getElementById('btnUpload');

    function formatSize(bytes){
      if (!bytes && bytes !== 0) return '';
      const kb = bytes / 1024;
      if (kb < 1024) return kb.toFixed(1) + ' KB';
      return (kb/1024).toFixed(2) + ' MB';
    }

    function refreshFilesList(){
      filesList.innerHTML = '';
      const files = fileInput.files;
      if (!files.length){
        filesList.textContent = 'Nenhum arquivo selecionado.';
        return;
      }
      Array.from(files).forEach(f=>{
        const div = document.createElement('div');
        const nameSpan = document.createElement('span');
        nameSpan.className = 'name';
        nameSpan.textContent = f.name;
        const sizeSpan = document.createElement('span');
        sizeSpan.className = 'size';
        sizeSpan.textContent = formatSize(f.size);
        div.appendChild(nameSpan);
        div.appendChild(sizeSpan);
        filesList.appendChild(div);
      });
    }

    dropZone.addEventListener('click', () => fileInput.click());

    dropZone.addEventListener('dragover', (e)=>{
      e.preventDefault();
      dropZone.classList.add('dragover');
    });
    dropZone.addEventListener('dragleave', (e)=>{
      e.preventDefault();
      dropZone.classList.remove('dragover');
    });
    dropZone.addEventListener('drop', (e)=>{
      e.preventDefault();
      dropZone.classList.remove('dragover');
      if (e.dataTransfer && e.dataTransfer.files.length){
        fileInput.files = e.dataTransfer.files;
        refreshFilesList();
      }
    });

    fileInput.addEventListener('change', refreshFilesList);

    btnClear.addEventListener('click', ()=>{
      fileInput.value = '';
      refreshFilesList();
      statusEl.textContent = '';
      statusEl.className = 'status';
    });

    function lerArquivoComoBase64(file){
      return new Promise((resolve, reject)=>{
        const reader = new FileReader();
        reader.onload = () => {
          const result = reader.result || '';
          const base64 = String(result).split(',')[1] || '';
          resolve({
            nome: file.name,
            tipo: file.type || 'application/vnd.google-earth.kml+xml',
            conteudo: base64
          });
        };
        reader.onerror = () => reject(reader.error);
        reader.readAsDataURL(file);
      });
    }

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();

      const files = fileInput.files;
      if (!files.length){
        statusEl.textContent = 'Selecione pelo menos um arquivo antes de enviar.';
        statusEl.className = 'status err';
        return;
      }

      statusEl.textContent = 'Enviando arquivos para o Drive...';
      statusEl.className = 'status';
      btnUpload.disabled = true;
      btnClear.disabled  = true;

      try{
        const arquivosPayload = await Promise.all(
          Array.from(files).map(lerArquivoComoBase64)
        );

        // IMPORTANTE: mode: 'no-cors' e sem Content-Type customizado
        await fetch(SCRIPT_URL, {
          method: 'POST',
          mode: 'no-cors',
          body: JSON.stringify({ arquivos: arquivosPayload })
        });

        // Não conseguimos ler a resposta (por causa do no-cors),
        // então mostramos uma mensagem genérica de sucesso.
        statusEl.textContent = 'Arquivos enviados. Verifique a pasta no Drive.';
        statusEl.className = 'status ok';

      }catch(err){
        statusEl.textContent = 'Erro ao enviar: ' + err;
        statusEl.className = 'status err';
      }finally{
        btnUpload.disabled = false;
        btnClear.disabled  = false;
      }
    });

    // estado inicial
    refreshFilesList();
  </script>
</body>
</html>
