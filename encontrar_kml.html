<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Visualizador de KML por OS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    :root {
      --accent: #16a34a;
      --accent-light: #bbf7d0;
      --bg: #0b1120;
      --card-bg: #020617;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --border: #1f2937;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #172554 0, #020617 45%, #000 100%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      align-items: stretch;
      justify-content: center;
    }

    .container {
      width: 100%;
      max-width: 1200px;
      margin: 16px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .card {
      background: linear-gradient(135deg, rgba(22, 163, 74, 0.06), rgba(15, 23, 42, 0.95));
      border-radius: 16px;
      border: 1px solid rgba(148, 163, 184, 0.15);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.6);
      padding: 16px 18px;
      backdrop-filter: blur(18px);
    }

    /* Improved header and form visuals */
    .header .title { display: flex; align-items: center; gap: 10px; }
    .header .title::before{ content: ''; width:10px; height:10px; background: linear-gradient(45deg,#22c55e,#16a34a); border-radius:3px; display:inline-block; }

    .form-row { align-items: center; gap: 10px; }
    .form-row label { width: 120px; min-width: 90px; }
    .form-row input[type="text"] { max-width: 260px; }

    /* Button styles */
    .btn-action { background: linear-gradient(135deg,#10b981,#059669); color: #052014; }
    .btn-secondary { background: transparent; color: var(--muted); border: 1px solid rgba(148,163,184,0.18); }
    .form-row button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 9px 14px;
      position: relative;
      min-height: 40px;
    }
    .btn-label { display: inline-flex; align-items: center; font-weight: 600; letter-spacing: 0.01em; }
    .btn-icon {
      width: 18px;
      height: 18px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      color: inherit;
    }
    .btn-icon svg { width: 100%; height: 100%; }

    /* Make map card stand out slightly more */
    .card[style] { padding: 12px; }
    #map { border-radius: 12px; border: 1px solid rgba(255,255,255,0.03); }

    .header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 8px;
      align-items: center;
      margin-bottom: 8px;
    }
    .header-actions { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }

    .title {
      font-size: 1.2rem;
      font-weight: 600;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: var(--accent-light);
    }

    .subtitle {
      font-size: 0.8rem;
      color: var(--muted);
    }

    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-top: 8px;
    }

    label {
      font-size: 0.8rem;
      color: var(--muted);
    }

    input[type="text"] {
      flex: 1;
      min-width: 140px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      font-size: 0.9rem;
      background: rgba(15, 23, 42, 0.95);
      color: var(--text);
      outline: none;
    }

    input[type="text"]:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(22, 163, 74, 0.6);
    }

    button {
      padding: 6px 14px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: #022c22;
      box-shadow: 0 10px 25px rgba(21, 128, 61, 0.4);
      transition: transform 0.08s ease, box-shadow 0.08s ease, filter 0.1s ease;
    }

    button:hover {
      transform: translateY(-1px);
      filter: brightness(1.05);
      box-shadow: 0 16px 35px rgba(22, 163, 74, 0.5);
    }

    button:active {
      transform: translateY(0);
      box-shadow: 0 8px 18px rgba(22, 163, 74, 0.3);
    }

    button:disabled {
      opacity: 0.55;
      cursor: not-allowed;
      box-shadow: none;
      filter: none;
    }

    .btn-secondary {
      background: transparent;
      color: var(--muted);
      border: 1px solid rgba(148, 163, 184, 0.4);
      box-shadow: none;
    }

    .btn-secondary:hover {
      background: rgba(15, 23, 42, 0.9);
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.7);
    }

    #message {
      margin-top: 6px;
      font-size: 0.8rem;
      min-height: 1.2em;
    }

    #message.success {
      color: #bbf7d0;
    }

    #message.error {
      color: #fecaca;
    }

    #map {
      width: 100%;
      height: calc(100vh - 180px);
      min-height: 360px;
      border-radius: 16px;
      overflow: hidden;
      border: 1px solid rgba(148, 163, 184, 0.15);
    }

    .map-footer {
      font-size: 0.75rem;
      color: var(--muted);
      margin-top: 6px;
      display: flex;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
    }

    @media (max-width: 768px) {
      .container {
        margin: 10px;
      }

      #map {
        height: calc(100vh - 220px);
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="header">
        <div>
          <div class="title">Visualizador de OS ¬∑ KML</div>
          <div class="subtitle">Digite o n√∫mero da OS para carregar o desenho da √°rea diretamente do Google Drive.</div>
        </div>
        <div class="header-actions">
          <button type="button" class="btn-secondary" onclick="window.location.href='index.html'">
            <i class="btn-icon" data-lucide="arrow-left"></i>
            <span class="btn-label">Voltar</span>
          </button>
        </div>
      </div>

      <div class="form-row">
        <label for="osInput">N√∫mero da OS</label>
        <input type="text" id="osInput" placeholder="Ex: 710987" />
        <button id="btnBuscar" type="button" class="btn-action">
          <i class="btn-icon" data-lucide="search"></i>
          <span class="btn-label">Buscar KML</span>
        </button>
        <button id="btnLimpar" type="button" class="btn-secondary">
          <i class="btn-icon" data-lucide="trash-2"></i>
          <span class="btn-label">Limpar mapa</span>
        </button>
        <button id="btnDownload" type="button" class="btn-secondary" disabled>
          <i class="btn-icon" data-lucide="download-cloud"></i>
          <span class="btn-label">Baixar KML</span>
        </button>
        <button id="btnNavigate" type="button" class="btn-secondary" disabled>
          <i class="btn-icon" data-lucide="navigation-2"></i>
          <span class="btn-label">Navegar at√© √°rea</span>
        </button>
        <button id="btnLocate" type="button" class="btn-secondary">
          <i class="btn-icon" data-lucide="map-pin"></i>
          <span class="btn-label">Minha posi√ß√£o</span>
        </button>
      </div>

      <div id="message"></div>
    </div>

    <div class="card" style="padding: 10px 12px;">
      <div id="map"></div>
      <div class="map-footer">
        <span>üõ∞Ô∏è Zoom autom√°tico na √°rea encontrada ¬∑ pol√≠gonos em destaque e popup com nome + √°rea (ha).</span>
        <span id="statusInfo"></span>
      </div>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- toGeoJSON (ESSENCIAL para KML funcionar) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/togeojson/0.16.0/togeojson.min.js"></script>

  <!-- Turf.js (c√°lculo de √°rea em ha) -->
  <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>

  <!-- Lucide icons -->
  <script src="https://cdn.jsdelivr.net/npm/lucide@0.278.0/dist/lucide.min.js"></script>

  <script>
    // URL da sua API do Apps Script (Web App)
    const API_URL = "https://script.google.com/macros/s/AKfycbyfZicaO3Oj60oEVZRgBgKw5xqGmqHpIZljsJWF-yTglqPoFvppfCOnnLhZ6rHYweSN/exec";

    let map;
    let kmlLayer = null;
    let lastKmlText = null;
    let lastKmlFileName = null;
    let lastKmlOS = null;
    let lastGeoJson = null;
    let lastUserMarker = null;
    let lastUserAccuracy = null;

    function initMap() {
      map = L.map('map', {
        zoomControl: true,
        attributionControl: true
      }).setView([-15.8, -48.5], 4); // Brasil

      // Base layers
      const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap'
      });

      // Esri World Imagery (satellite)
      const esriSat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        maxZoom: 19,
        attribution: 'Tiles &copy; Esri &mdash; Source: Esri, DigitalGlobe, GeoEye, Earthstar Geographics'
      });

      const baseLayers = {
        'Mapa (OSM)': osm,
        'Sat√©lite (Esri)': esriSat
      };

      // Add default base (OSM)
      osm.addTo(map);

      // Add layer control (base layers)
      L.control.layers(baseLayers, null, { collapsed: false }).addTo(map);

      // Add simple compass/north indicator
      const compassControl = L.control({ position: 'topleft' });
      compassControl.onAdd = function() {
        const div = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
        div.innerHTML = '<div style="width:40px;height:40px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:24px;background:#fff;border-radius:4px;">‚Üë</div>';
        div.style.marginTop = '50px';
        L.DomEvent.on(div, 'click', function(){
          map.setView(map.getCenter(), map.getZoom());
        });
        return div;
      };
      compassControl.addTo(map);
    }

    function setMessage(text, type) {
      const messageEl = document.getElementById('message');
      messageEl.textContent = text || '';
      messageEl.className = '';
      if (type) {
        messageEl.classList.add(type);
      }
    }

    function setStatus(text) {
      document.getElementById('statusInfo').textContent = text || '';
    }

    function limparMapa() {
      if (kmlLayer) {
        map.removeLayer(kmlLayer);
        kmlLayer = null;
      }
      setStatus('');
    }

    // Busca usando JSONP (sem CORS)
    function buscarKml() {
      const osNumero = document.getElementById('osInput').value.trim();

      if (!osNumero) {
        setMessage('Digite o n√∫mero da OS.', 'error');
        return;
      }

      setMessage('Buscando KML no Google Drive...', 'success');
      setStatus('');

      // reset last KML / disable download until loaded
      lastKmlText = null;
      lastKmlFileName = null;
      lastKmlOS = null;
      enableDownload(false);

      // remove script antigo (se existir)
      const oldScript = document.getElementById('jsonp_kml_script');
      if (oldScript) {
        oldScript.remove();
      }

      // callback global que o Apps Script vai chamar
      window.handleKmlResponse = function (data) {
        if (!data || !data.success) {
          limparMapa();
          setMessage(data && data.message ? data.message : 'KML n√£o encontrado.', 'error');
          return;
        }

        // store last KML for download
        lastKmlText = data.kmlContent || null;
        lastKmlFileName = data.fileName ? String(data.fileName) : `OS_${osNumero}.kml`;
        lastKmlOS = osNumero;
        enableDownload(!!lastKmlText);

        setMessage('KML carregado: ' + (data.fileName || ''), 'success');
        renderKmlOnMap(data.kmlContent, data.fileName, osNumero);
      };

      // cria script JSONP
      const script = document.createElement('script');
      script.id = 'jsonp_kml_script';
      script.src = `${API_URL}?os=${encodeURIComponent(osNumero)}&callback=handleKmlResponse&_=${Date.now()}`;
      document.body.appendChild(script);
    }

    function renderKmlOnMap(kmlText, fileName, osNumero) {
      try {
        if (kmlLayer) {
          map.removeLayer(kmlLayer);
          kmlLayer = null;
        }

        const parser = new DOMParser();
        const kmlDom = parser.parseFromString(kmlText, 'text/xml');
        const geojson = toGeoJSON.kml(kmlDom);

        // store geojson for navigation / other actions
        try{ lastGeoJson = geojson; }catch(_e){ lastGeoJson = null; }

        if (!geojson || !geojson.features || geojson.features.length === 0) {
          setMessage('KML carregado, mas sem fei√ß√µes v√°lidas para exibi√ß√£o.', 'error');
          return;
        }

        let totalAreaHa = 0;

        kmlLayer = L.geoJSON(geojson, {
          style: function (feature) {
            return {
              color: '#22c55e',
              weight: 2,
              fillColor: '#16a34a',
              fillOpacity: 0.35
            };
          },
          onEachFeature: function (feature, layer) {
            const props = feature.properties || {};

            // Nome principal (se quiser pode usar o nome da fazenda)
            let nome = props.name || props.NOME || props.Nome || '';
            if (!nome) {
                nome = props.nome_faz || fileName || ('OS ' + osNumero);
            }

            // Campos do KML (fazenda, talh√£o, √°rea declarada)
            const codFazenda = props.fazenda || props['tal:fazenda'] || '';
            const nomeFazenda = props.nome_faz || props['tal:nome_faz'] || '';
            const talhao = props.talhao || props['tal:talhao'] || '';
            const areaAttr = props.area || props['tal:area'] || '';

            // √Årea calculada pela geometria
            let areaHa = 0;
            try {
                const areaM2 = turf.area(feature);
                areaHa = areaM2 / 10000.0;
                totalAreaHa += areaHa;
            } catch (e) {
                // se n√£o for pol√≠gono, ignora
            }

            const popupHtml = `
                <strong>${nome}</strong><br>
                OS: <strong>${osNumero}</strong><br>
                Fazenda: ${nomeFazenda || '-'} ${codFazenda ? '(' + codFazenda + ')' : ''}<br>
                Talh√£o: ${talhao || '-'}<br>
                √Årea (KML): ${areaAttr ? Number(areaAttr).toFixed(2) + ' ha' : '-'}<br>
                √Årea (geometria): ${areaHa > 0 ? areaHa.toFixed(2) + ' ha' : 'n√£o calculada'}
            `;

            layer.bindPopup(popupHtml);
            
          }
        }).addTo(map);

        try {
          map.fitBounds(kmlLayer.getBounds(), { padding: [20, 20] });
        } catch (e) {
          console.log('N√£o foi poss√≠vel ajustar o zoom automaticamente:', e);
        }

        if (totalAreaHa > 0) {
          setStatus('√Årea total estimada: ' + totalAreaHa.toFixed(2) + ' ha');
        } else {
          setStatus('');
        }

        // enable navigation if we have a geojson
        try{ enableNav(!!lastGeoJson); }catch(_e){}

      } catch (e) {
        console.error(e);
        setMessage('Erro ao processar o KML no mapa: ' + e, 'error');
      }
    }

    function enableNav(enabled){
      const btn = document.getElementById('btnNavigate');
      if (!btn) return;
      btn.disabled = !enabled;
      if (enabled) btn.classList.remove('btn-secondary');
      else btn.classList.add('btn-secondary');
      try{ if (window.lucide) lucide.createIcons(); }catch(_e){}
    }

    function navigateToKml(){
      if (!lastGeoJson){
        setMessage('Nenhuma √°rea carregada para navegar.', 'error');
        return;
      }

      // compute centroid of the whole feature collection
      let centroid;
      try{
        centroid = turf.centroid(lastGeoJson);
      }catch(e){
        console.error('Erro ao calcular centroid:', e);
        setMessage('N√£o foi poss√≠vel calcular ponto de destino.', 'error');
        return;
      }

      if (!centroid || !centroid.geometry || !centroid.geometry.coordinates) {
        setMessage('Ponto de destino inv√°lido.', 'error');
        return;
      }

      // turf returns [lon, lat]
      const [lon, lat] = centroid.geometry.coordinates;
      const destLat = Number(lat);
      const destLon = Number(lon);

      setMessage('Obtendo sua posi√ß√£o para navega√ß√£o...', 'success');

      // Try to get current position and open Google Maps directions
      if (navigator.geolocation){
        navigator.geolocation.getCurrentPosition(function(pos){
          const oLat = pos.coords.latitude;
          const oLon = pos.coords.longitude;
          const origin = `${oLat},${oLon}`;
          const destination = `${destLat},${destLon}`;
          const url = `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(origin)}&destination=${encodeURIComponent(destination)}&travelmode=driving`;
          window.open(url, '_blank');
        }, function(err){
          console.warn('Geolocation failed or denied:', err);
          setMessage('N√£o foi poss√≠vel obter sua localiza√ß√£o ‚Äî abrindo destino no Google Maps.', 'error');
          const destination = `${destLat},${destLon}`;
          const url = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(destination)}`;
          window.open(url, '_blank');
        }, { enableHighAccuracy: true, timeout: 8000 });
      } else {
        setMessage('Geolocaliza√ß√£o n√£o suportada ‚Äî abrindo destino no Google Maps.', 'error');
        const destination = `${destLat},${destLon}`;
        const url = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(destination)}`;
        window.open(url, '_blank');
      }
    }

    function enableDownload(enabled){
      const btn = document.getElementById('btnDownload');
      if (!btn) return;
      btn.disabled = !enabled;
      if (enabled) btn.classList.remove('btn-secondary');
      else btn.classList.add('btn-secondary');
      try{ if (window.lucide) lucide.createIcons(); }catch(_e){}
    }

    function downloadKml(){
      if (!lastKmlText){
        setMessage('Nenhum KML dispon√≠vel para download.', 'error');
        return;
      }
      try{
        const blob = new Blob([lastKmlText], { type: 'application/vnd.google-earth.kml+xml;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = lastKmlFileName || (`kml_${lastKmlOS||''}.kml`);
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
        setMessage('Download iniciado: ' + a.download, 'success');
      }catch(e){
        console.error(e);
        setMessage('Falha ao iniciar download: ' + e, 'error');
      }
    }

    // Geolocation: show user's current position on the map
    function showUserLocation(){
      if (!navigator.geolocation){
        setMessage('Navegador n√£o suporta geolocaliza√ß√£o.', 'error');
        return;
      }
      setMessage('Obtendo sua localiza√ß√£o...', 'success');
      navigator.geolocation.getCurrentPosition(function(pos){
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        const accuracy = pos.coords.accuracy || 0;

        // remove previous marker/circle
        if (lastUserMarker){
          try{ map.removeLayer(lastUserMarker); }catch(_e){}
          lastUserMarker = null;
        }
        if (lastUserAccuracy){
          try{ map.removeLayer(lastUserAccuracy); }catch(_e){}
          lastUserAccuracy = null;
        }

        lastUserMarker = L.marker([lat, lon]).addTo(map).bindPopup('Sua posi√ß√£o').openPopup();
        lastUserAccuracy = L.circle([lat, lon], { radius: accuracy, color: '#3b82f6', fillColor: '#bfdbfe', fillOpacity: 0.25 }).addTo(map);

        try{ map.panTo([lat, lon]); }catch(_e){}
        setMessage('Posi√ß√£o localizada (precis√£o ‚âà ' + Math.round(accuracy) + ' m).', 'success');
      }, function(err){
        console.warn('Geolocation error', err);
        setMessage('N√£o foi poss√≠vel obter sua localiza√ß√£o: ' + (err && err.message ? err.message : err), 'error');
      }, { enableHighAccuracy: true, timeout: 10000 });
    }

    document.addEventListener('DOMContentLoaded', function () {
      initMap();

      document.getElementById('btnBuscar').addEventListener('click', buscarKml);
      document.getElementById('btnLimpar').addEventListener('click', () => {
        limparMapa();
        setMessage('Mapa limpo. Digite uma nova OS para buscar.', 'success');
      });

      const btnDl = document.getElementById('btnDownload');
      if (btnDl) btnDl.addEventListener('click', downloadKml);
      const btnNav = document.getElementById('btnNavigate');
      if (btnNav) btnNav.addEventListener('click', navigateToKml);
      const btnLocate = document.getElementById('btnLocate');
      if (btnLocate) btnLocate.addEventListener('click', showUserLocation);

      // Initialize Lucide icons with limited retries to avoid console spam
      let lucideInitAttempts = 0;
      const maxLucideRetries = 5;
      const lucideRetryDelay = 250;

      function initLucide(){
        if (window.lucide && typeof lucide.createIcons === 'function') {
          try {
            lucide.createIcons();
            console.log('Lucide icons initialized');
          } catch(e) {
            console.error('Lucide init error:', e);
          }
          return;
        }

        lucideInitAttempts += 1;
        if (lucideInitAttempts <= maxLucideRetries) {
          if (lucideInitAttempts === 1) {
            console.warn('Lucide not available yet, retrying...');
          }
          setTimeout(initLucide, lucideRetryDelay);
        } else {
          console.error('Lucide failed to load after retries.');
        }
      }

      const lucideScriptTag = document.querySelector('script[src*="lucide"]');
      if (lucideScriptTag) {
        lucideScriptTag.addEventListener('load', initLucide);
      }
      initLucide();

      document.getElementById('osInput').addEventListener('keydown', function (e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          buscarKml();
        }
      });
    });
  </script>
</body>
</html>
